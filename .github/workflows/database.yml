name: Run tests

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x]
        mongodb-version: [4.4]

    steps:
    - name: Git checkout
      uses: actions/checkout@v2

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Start MongoDB
      uses: supercharge/mongodb-github-action@1.3.0
      with:
        mongodb-version: ${{ matrix.mongodb-version }}
        mongodb-replica-set: test-rs
        

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: npm test
      env:
        CI: true



    cypress-run:
      needs: build
      runs-on: ubuntu-latest
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      steps:
        - name: Checkout
          uses: actions/checkout@v2
              
        # Install NPM dependencies, cache them correctly
        # and run all Cypress tests
        - name: Cypress run
          uses: cypress-io/github-action@v2
          with:
            start: npm run start:test
            #build: npm run test:integration
            wait-on: http://localhost:3030
            
